# torch_to_fortran-
作者：马钰斌
中国科学院大气物理研究所

for pytorch to fortran

这个软件为了更好的将现代深度学习算法和传统的大型计算模式相结合。

我们建构建了一个torch和fortran代码的一个接口，fortran并不擅长人工智能类的编程，但是在大规模计算方面计算效率是很高的。我们的想法是，在现有框架（pytorch）下训练模型，再将训练好的模型架构和参数传递到用fortran 构建的大气海洋模式中。

在之前我们通过手动将一层神经网络放入过模式并取得成功，当时是将python传出参数等手动粘贴到fortran的代码当中，这也获得了成功，但是在可扩展性和便利性存在问题，这种手工的方法，每次训练完之后就需要手动将参数加进代码是很不方便的，如果多层成千上万的参数这是难以实现的。因此我们写了一个接口，python程序训练好模型后，会将模型参数存为txt,然后再由我们的TBF程序将参数传输进模式中，（具体的流程在流程图中展示，其中的计算过程在计算图中展示）这样大大方便了模型的改进，也使得巨大的参数数组能够轻易加入地球系统模式。


层，每层都有n 个计算节点。

我们把输入x设成有m 个元素的向量x(m) ，索引 j = 1:m,把W设计成一个三维数组W(n,m,o),w(i,j,k),k表示第k层，k =1: o;i 表示这层第i个节点，i = 1: n;j表示与第j个因子相乘的权重；把b 设成一个二维数组b(n,o),b(i,k),索引i表示第i个节点上的偏差，k表示第k层上的偏差；把c设成一个一维向量c(n),索引i= 1,n表示第i个节点上的权重；把d设成一个标量。

使用方法： 
      program main 


!torch_bridge_fortran 被写成了module，方便在其他程序中调用
!其中使用者可以把它当成黑箱，深度学习训练好的模型被封装在其中
!需要输入的是一个二维数组，x_array(cesm_m,ncol),cesm_m 是因子个数
!ncol和cesm的ncol是一致的。输出的y_cesm就是深度模型的计算量
!x1, i --|              ______
!x2, i --|             |     |     
!x3, i --|---------->  | box | ------->  y_cesm(i)
!x4, i --|             |_____|
!x5, i --|              

!这是cesm中调用TBF的一个实例程序，在bridge程序中，计算被进行
!参数传递的过程在bridge进行，
!参数优化的过程则是在python文件夹下进行
!计算过程则主要写在calculation.f90中，这一部分不建议修改，需要对深度模型很了解
!文件读取在file_io.f90中进行
!----------------------------------------------------------------

!在fortran模型代码中，我们主要需要做下面几件事


!1.use module 

        use bridge , only: tbf
         

!-----------------------------------------------------------------

!2.申明变量和变量的维度

        implicit none 
        integer              :: m = 4
        real,allocatable     :: x_array(:,:)
        real                 :: y_cesm(5)
        character(len = 100) :: dirname ="/data/chengxl/&
                         pblh_deeplearning/torch_bridge_fortran/python/"
 
!-----------------------------------------------------------------

!3.明确自变量（可以通过其他函数传递）!如果多个变量向量则需要进行数组拼接
        allocate(x_array(m,5))

        x_array(:,1) = (/264.32004,0.3210011,14510.625,52310.562/)
        x_array(:,2) = (/264.31717,0.32086015,14449.125,52227.875/)
        x_array(:,3) = (/264.31717,0.32067218,14449.125,52186.5/)
        x_array(:,4) = (/264.31573,0.3205077,14449.125,52062.375/)
        x_array(:,5) = (/264.31573,0.3203667,14387.5,51979.688/)

